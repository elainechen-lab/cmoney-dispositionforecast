<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CMoney 處置股票預測</title>

  <style>
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      padding:16px;
      line-height:1.6;
      background:#fff;
      color:#111;
    }
    h2{margin:0 0 8px}
    .muted{opacity:.65;font-size:13px}
    .err{color:#b00020}
    .card{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
      margin:14px 0;
      background:#fff;
    }
    .card b{font-size:15px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    th,td{
      border-bottom:1px solid #eee;
      padding:8px;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      background:#fafafa;
      font-weight:600;
    }
    pre{
      margin:8px 0 0;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.5;
    }
  </style>
</head>

<body>
  <h2>處置股預測</h2>
  <div id="status" class="muted">資料載入中…</div>
  <div id="content"></div>

<script>
/* ================================
 * Apps Script Web App（API 基底）
 * ================================ */
const API_BASE =
  "https://script.google.com/macros/s/AKfycbyK4c878VDnAZXu2swJgPVs5lfRGYmFC-6Fm9ZwRpIC12WWimcctNN8mYOLu1dipEC4/exec";

/* ================================
 * 工具
 * ================================ */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
  );
}

function tableFrom(sheetObj){
  if(!sheetObj) return "";
  const { headers, rows, sheetName } = sheetObj;
  if(!headers || !headers.length){
    return `<div class="card muted">（${escapeHtml(sheetName)} 無資料）</div>`;
  }

  const head =
    `<tr>${headers.map(h=>`<th>${escapeHtml(h)}</th>`).join("")}</tr>`;

  const body = (rows || []).map(r =>
    `<tr>${headers.map(h=>`<td>${escapeHtml(r[h])}</td>`).join("")}</tr>`
  ).join("");

  return `
    <div class="card">
      <b>${escapeHtml(sheetName)}</b>
      <div style="overflow:auto">
        <table>${head}${body}</table>
      </div>
    </div>`;
}

/* ================================
 * JSONP Loader（關鍵）
 * 不用 fetch、不吃 CORS、不怕手機
 * ================================ */
function loadAllDataJsonp(){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      script.remove();
    }

    script.onerror = () => {
      cleanup();
      reject(new Error("JSONP 載入失敗"));
    };

    script.src =
      `${API_BASE}?api=1&callback=${cb}&_=${Date.now()}`;
    document.body.appendChild(script);
  });
}

/* ================================
 * 主流程
 * ================================ */
(async () => {
  const status = document.getElementById("status");
  const content = document.getElementById("content");

  try{
    const data = await loadAllDataJsonp();

    status.textContent =
      `交易日：${data.tradeDate || ""} ｜ 更新時間：` +
      new Date(data.updatedAt).toLocaleString();

    const d = data.data || {};

    content.innerHTML =
      tableFrom(d.soonRelease) +
      tableFrom(d.disposed) +
      tableFrom(d.up) +
      `<div class="card"><b>漲說明</b><pre>${escapeHtml(d.upNote?.text)}</pre></div>` +
      tableFrom(d.down) +
      `<div class="card"><b>跌說明</b><pre>${escapeHtml(d.downNote?.text)}</pre></div>` +
      tableFrom(d.fastestN);

  }catch(err){
    status.innerHTML =
      `<span class="err">資料載入失敗：${escapeHtml(err.message)}</span>`;
  }
})();
</script>

</body>
</html>
