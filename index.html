<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>處置股預測</title>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0f1a33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.12);
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --radius:16px;

      --accent:#ff6b6b;
      --accent2:#f59e0b;
      --ok:#22c55e;

      --warnRowBg:rgba(253,186,116,.18);
      --noteBg:rgba(255,255,255,.05);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(255,107,107,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(245,158,11,.16), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }

    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 40px;}

    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      padding:8px 4px 14px;
    }
    .title{
      font-size:22px; font-weight:800; letter-spacing:.5px;
    }
    .sub{
      font-size:12px; color:var(--muted); margin-top:6px;
    }
    .meta{
      text-align:right; font-size:12px; color:var(--muted);
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      margin:10px 0 16px;
    }
    .tab{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
      transition:transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .tab:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    .tab.active{
      border-color:rgba(255,255,255,.22);
      background:rgba(255,255,255,.08);
    }

    .panel{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panelHd h2{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* ====== Desktop list/table (general) ====== */
    .tableWrap{overflow:auto}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width:860px;
    }
    thead th{
      position:sticky; top:0;
      background:rgba(255,255,255,.06);
      color:var(--muted);
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-weight:700;
      z-index:1;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    tbody tr:hover td{background:rgba(255,255,255,.03)}
    tbody tr.warn td{background:var(--warnRowBg)}
    .center{text-align:center}

    /* ====== Cards (Up/Down desktop requirement) ====== */
    .cards{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;
      padding:12px;
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
    }
    .cardTop{
      padding:12px 12px 10px;
      display:flex; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    .cardLeft{min-width:0}
    .stk{
      display:flex; gap:8px; align-items:baseline; flex-wrap:wrap;
      font-weight:800;
    }
    .code{font-size:14px}
    .name{font-size:13px; color:var(--muted); font-weight:700}
    .badgeRow{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .badge{
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:999px;
      color:var(--text);
      white-space:nowrap;
    }
    .badge.em{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.10)}
    .badge.warn{border-color:rgba(245,158,11,.40); background:rgba(245,158,11,.12)}
    .cardRight{
      text-align:right;
      display:flex; flex-direction:column; justify-content:center;
      gap:6px;
      min-width:110px;
    }
    .bigNum{
      font-size:18px; font-weight:900;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px; color:var(--muted);
    }

    /* ====== Collapsible note (both desktop & mobile) ====== */
    details.note{
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    details.note > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      color:var(--muted);
      font-size:13px;
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    details.note > summary::-webkit-details-marker{display:none}
    .chev{
      opacity:.8;
      transform:rotate(0deg);
      transition:transform .12s ease;
    }
    details.note[open] .chev{transform:rotate(90deg)}
    .noteBody{
      padding:10px 12px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      background:var(--noteBg);
      color:var(--text);
      font-size:13px;
      line-height:1.6;
      white-space:normal;
    }
    .noteTitle{
      font-weight:900;
      letter-spacing:.3px;
      margin-bottom:6px;
    }
    .noteStrong{
      font-weight:900;
    }

    /* ====== Mobile: keep "board" feel ====== */
    @media (max-width: 860px){
      .cards{grid-template-columns:1fr}
      table{min-width:760px}
    }

    @media (max-width: 640px){
      .wrap{padding:16px 12px 34px}
      .title{font-size:18px}
      .panelHd{padding:12px 12px}
      .cards{padding:10px}
      .cardTop{padding:10px}
      .bigNum{font-size:17px}
    }

    .loading{
      padding:22px 16px;
      color:var(--muted);
      font-size:13px;
    }
    .err{
      padding:16px;
      color:#fecaca;
      font-size:13px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,107,107,.10);
    }

    footer{
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">處置股預測</div>
        <div class="sub">資料來源：data.json（GitHub Pages）</div>
      </div>
      <div class="meta">
        <div>交易日：<span id="tradeDate">-</span></div>
        <div>更新時間：<span id="updatedAt">-</span></div>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="panel">
      <div class="panelHd">
        <h2 id="panelTitle">載入中…</h2>
        <div class="pill" id="panelPill">—</div>
      </div>
      <div id="panelBody" class="loading">開啟資料中…</div>
    </div>

    <footer>© CMoney. All rights reserved.</footer>
  </div>

  <script>
    // ===============================
    // ✅ 你的 data.json 路徑
    // ===============================
    // 如果 index.html 與 data.json 同層，就用 "./data.json"
    const DATA_URL = "./data.json";

    // ===============================
    // UI tabs order
    // ===============================
    const PANELS = [
      { key: "soonRelease", title: "即將出關" },
      { key: "disposed",    title: "處置中" },
      { key: "up",          title: "漲N%進處置" },
      { key: "down",        title: "跌N%進處置" },
      { key: "fastestN",    title: "最快N日進處置" }
    ];

    // 你指定要強制插入的條款文字
    const CLAUSE_LINE = "處置股票條款中有類股相關條款：其六日漲跌百分比與全體有價證券及同類有價證券依本項規定計算之平均值的差幅均在百分之二十以上，才符合條款。";

    let gPayload = null;

    // ===============================
    // Helpers
    // ===============================
    const esc = (s) => {
      if (s === null || s === undefined) return "";
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    };

    const isEmpty = (v) => v === null || v === undefined || String(v).trim() === "";

    const br = (s) => esc(s).replaceAll("\n", "<br>");

    // 用多個可能欄位名去猜（避免你 SP 欄位名有細微差異）
    const pick = (row, keys, fallback="") => {
      for (const k of keys){
        if (row && Object.prototype.hasOwnProperty.call(row, k) && !isEmpty(row[k])) return row[k];
      }
      return fallback;
    };

    // 取代常見欄位：代號/名稱/漲跌幅/循環時間/處置期間等
    const getCode = (row) => pick(row, ["標的代號","代號","股票代號","StockID","stockId","code"]);
    const getName = (row) => pick(row, ["標的名稱","名稱","股票名稱","StockName","stockName","name"]);
    const getPct  = (row) => pick(row, ["漲跌幅(%)","漲跌幅%","漲跌幅","N%","幅度","pct","Pct"]);
    const getVol  = (row) => pick(row, ["成交量","量","Volume","volume"]);
    const getLoop = (row) => pick(row, ["循環時間(分)","循環時間","循環時間(分鐘)","loop","Loop"]);
    const getStart= (row) => pick(row, ["處置起日","起日","StartDate","start"]);
    const getEnd  = (row) => pick(row, ["處置迄日","迄日","EndDate","end"]);
    const getDays = (row) => pick(row, ["剩餘天數","剩餘日","剩餘","daysLeft","DaysLeft"]);

    // 你的新說明欄位
    const getText1 = (row) => pick(row, ["文字內容1","文字1","內容1","Text1","text1"]);
    const getText2 = (row) => pick(row, ["文字內容2","文字2","內容2","Text2","text2"]);
    const getExtra = (row) => pick(row, ["補充說明","補充","Extra","extra","Note","note"]);

    // ===============================
    // Render tabs
    // ===============================
    function renderTabs(activeKey){
      const tabs = document.getElementById("tabs");
      tabs.innerHTML = "";
      for (const p of PANELS){
        const btn = document.createElement("div");
        btn.className = "tab" + (p.key === activeKey ? " active" : "");
        btn.textContent = p.title;
        btn.onclick = () => showPanel(p.key);
        tabs.appendChild(btn);
      }
    }

    // ===============================
    // Render generic table panel
    // ===============================
    function renderTable(pack){
      const headers = (pack && pack.headers) ? pack.headers : [];
      const rows = (pack && pack.rows) ? pack.rows : [];

      if (!headers.length) return `<div class="loading">沒有資料</div>`;

      const th = headers.map(h => `<th>${esc(h)}</th>`).join("");
      const body = rows.map(r => {
        const loop = getLoop(r);
        const warn = (!isEmpty(loop) && Number(loop) >= 20) ? "warn" : "";
        const tds = headers.map(h => {
          const v = (r && Object.prototype.hasOwnProperty.call(r, h)) ? r[h] : "";
          const cls = (typeof v === "number" || String(v).match(/^[-]?\d+(\.\d+)?$/)) ? "center" : "";
          return `<td class="${cls}">${esc(v)}</td>`;
        }).join("");
        return `<tr class="${warn}">${tds}</tr>`;
      }).join("");

      return `
        <div class="tableWrap">
          <table>
            <thead><tr>${th}</tr></thead>
            <tbody>${body}</tbody>
          </table>
        </div>
      `;
    }

    // ===============================
    // Render Up/Down cards with expandable notes
    // ===============================
    function renderUpDownCards(pack){
      const rows = (pack && pack.rows) ? pack.rows : [];
      if (!rows.length) return `<div class="loading">沒有資料</div>`;

      const html = rows.map(r => {
        const code = getCode(r);
        const name = getName(r);
        const pct  = getPct(r);
        const vol  = getVol(r);
        const loop = getLoop(r);
        const start= getStart(r);
        const end  = getEnd(r);
        const days = getDays(r);

        const t1 = getText1(r);
        const t2 = getText2(r);
        const ex = getExtra(r);
        const hasNote = !(isEmpty(t1) && isEmpty(t2) && isEmpty(ex));

        // badges: 你可以依照你現有欄位再加
        const badges = [];
        if (!isEmpty(start) || !isEmpty(end)) badges.push(`<span class="badge warn">處置期間 ${esc(start)} ~ ${esc(end)}</span>`);
        if (!isEmpty(days)) badges.push(`<span class="badge">剩餘 ${esc(days)} 天</span>`);
        if (!isEmpty(loop)) badges.push(`<span class="badge ${Number(loop) >= 20 ? "warn" : ""}">循環 ${esc(loop)} 分</span>`);
        if (!isEmpty(vol))  badges.push(`<span class="badge">量 ${esc(vol)}</span>`);

        const noteBlock = hasNote ? `
          <details class="note">
            <summary>
              <span>點我展開注意事項</span>
              <span class="chev">›</span>
            </summary>
            <div class="noteBody">
              <div class="noteTitle">【注意事項】</div>
              ${!isEmpty(t1) ? `<div>${br(t1)}</div>` : ``}
              <div class="noteStrong">**${esc(CLAUSE_LINE)}**</div>
              ${!isEmpty(t2) ? `<div style="margin-top:6px">${br(t2)}</div>` : ``}
              ${!isEmpty(ex) ? `<div style="margin-top:6px">${br(ex)}</div>` : ``}
            </div>
          </details>
        ` : ``;

        return `
          <div class="card">
            <div class="cardTop">
              <div class="cardLeft">
                <div class="stk">
                  <span class="code">${esc(code)}</span>
                  <span class="name">${esc(name)}</span>
                </div>
                <div class="badgeRow">
                  ${badges.join("")}
                </div>
              </div>
              <div class="cardRight">
                <div class="bigNum">${esc(pct)}</div>
                <div class="small">漲跌幅 / N%</div>
              </div>
            </div>
            ${noteBlock}
          </div>
        `;
      }).join("");

      return `<div class="cards">${html}</div>`;
    }

    // ===============================
    // Show panel
    // ===============================
    function showPanel(key){
      renderTabs(key);

      const panelTitle = document.getElementById("panelTitle");
      const panelPill  = document.getElementById("panelPill");
      const panelBody  = document.getElementById("panelBody");

      const p = PANELS.find(x => x.key === key);
      panelTitle.textContent = p ? p.title : key;

      const pack = gPayload?.data?.[key];
      const rowCount = pack?.rows ? pack.rows.length : 0;
      panelPill.textContent = `筆數：${rowCount}`;

      // Up/Down: 桌機要卡片式，手機也可保留同樣呈現（不破壞看板感）
      if (key === "up" || key === "down"){
        panelBody.className = "";
        panelBody.innerHTML = renderUpDownCards(pack);
        return;
      }

      // Other panels: keep table style
      panelBody.className = "";
      panelBody.innerHTML = renderTable(pack);
    }

    // ===============================
    // Load data.json
    // ===============================
    async function loadData(){
      const panelBody = document.getElementById("panelBody");
      panelBody.className = "loading";
      panelBody.textContent = "開啟資料中…";

      try{
        const res = await fetch(`${DATA_URL}?t=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        gPayload = payload;

        document.getElementById("tradeDate").textContent = payload.tradeDate || "-";
        document.getElementById("updatedAt").textContent = payload.updatedAt ? payload.updatedAt : "-";

        // default panel
        showPanel("soonRelease");
      }catch(err){
        panelBody.className = "err";
        panelBody.innerHTML = `讀取 data.json 失敗：${esc(err.message)}<br>請確認 DATA_URL 是否正確，以及 GitHub Pages 是否已更新。`;
      }
    }

    loadData();
  </script>
</body>
</html>
